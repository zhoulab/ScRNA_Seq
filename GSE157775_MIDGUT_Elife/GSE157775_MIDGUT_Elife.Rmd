---
title: "GSE157775 MIDGUT Elife"
output: html_notebook
---

#Objective: 
## 1. First check if there is any hemocytes in this dataset
## 2. Check if III markers are expressed in other cells in midgut

#Important files***:
## 1. GSE157775_cell_annotation.csv: Auhtor's annotation
## 2. GSE157775_sce.RDS: RDS of Seurat OBJ the author's put on GEO
*** These files can be downloaded at https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE157775

################################
set wk dir and library packages
```{r}
setwd(getwd())
getwd()
library(Seurat)
library(ggplot2)
library(cowplot)
library(Matrix)
library(dplyr)
library(data.table)
library(tidyverse)
library(remotes)
library(data.table)
library(ggrepel)
```

load saved wkimage if needed
```{r}
load("./MIDGUT_Elife_wkimage.RData")
```


create an obj of III markers (lab's Bulk IMs)
```{r}
III_Markers <- c("SPH93",
                 "CecA1",
                 "CecA2",
                 "AttA",
                 "AttB",
                 "AttC",
                 "DptA",
                 "DptB",
                 "Dro",
                 "Mtk",
                 "IM18",
                 "edin")
```


Import SOBJ and author's annotation
```{r}
Author_metadata <- fread("./raw_data/GSE157775_cell_annotation.csv",header = T)
MIDGUT_Elife <- readRDS("./raw_data/GSE157775_sce.RDS")

#convert into seurat OBJ
MIDGUT_Elife <- as.Seurat(MIDGUT_Elife)
```

First check if cell IDs match
```{r}
table(
  MIDGUT_Elife@meta.data$cellID%in%Author_metadata$cellID
)
```
Export the seurat object to a dataframe where rows are gene IDs, and columns are cells; Need to convert FBgn to gene symbols first with flybase ID validator, then convert the datafram back to SOBJ (otherwise features generated in every slot will be FBgn, currently cannot be directly converted, not even coerce)
```{r}
expr_df <- GetAssayData(MIDGUT_Elife, layer = "counts")  # for counts

# Convert to a dataframe
expr_df <- as.data.frame(as.matrix(expr_df))

# Ensure the row names are gene IDs and column names are cell IDs
write.table(file = "./processed_data/SOBJ/MIDGUT_SOBJ_FBgn.txt",
            rownames(expr_df),
            sep = ",",
            quote = F,
            col.names = F,
            row.names = F
            )

```


Provides tables for converting and annotating Ensembl Gene IDs.
```{r}
#devtools::install_github("stephenturner/annotables")
library(annotables)
BDGP6 <- annotables::bdgp6

table(duplicated(BDGP6$symbol))
table(duplicated(rownames(expr_df)))

BDGP6 <- BDGP6[!duplicated(BDGP6$ensgene),]
BDGP6 <- BDGP6[!duplicated(BDGP6$symbol),]
table(duplicated(BDGP6$symbol))


table(rownames(expr_df)%in%BDGP6$ensgene)
```


Convert FBgn to Gene symbol
```{r}
convert_fbgn_to_symbol <- function(expr_df, annotation_df) {
  expr_df$FBgn <- rownames(expr_df)

  # Merge annotation (BDGP6) with expression data
  merged_df <- merge(expr_df, annotation_df[, c("ensgene", "symbol")], 
                     by.x = "FBgn", by.y = "ensgene", all.x = TRUE)

  # Ensure unique gene symbols
  merged_df$symbol <- make.unique(as.character(merged_df$symbol))

  # Set rownames as FBgn (to avoid duplicates)
  rownames(merged_df) <- merged_df$FBgn

  # Keep Gene Symbol as a separate column
  merged_df <- merged_df[, c("symbol", setdiff(colnames(merged_df), c("symbol", "FBgn")))]

  return(merged_df)
}



# Convert FBgn IDs to Gene Symbols
converted_expr_df <- convert_fbgn_to_symbol(expr_df, BDGP6)
converted_expr_df <- na.omit(converted_expr_df)
rownames(converted_expr_df) <- converted_expr_df$symbol
converted_expr_df <- converted_expr_df[,-1]

dim(converted_expr_df)
```

convert mapped expr to SOBJ
```{r}
MIDGUT_Elife2 <- CreateSeuratObject(counts = converted_expr_df)

# add cellID in meta.data slot of SOBJ
MIDGUT_Elife2@meta.data$'cellID' <- colnames(converted_expr_df)
```


For the scRNA-seq experiments, we used the wild-type WDah fly line and dissected whole midguts at young (~7d), mid-age (~30d) and old time-points (~60d)

Whole midguts from adult female flies were dissected in 1xPBS and fixed in a fixative solution 

Drosophila melanogaster reference genome (BDGP6)

format metadata; merge author's annotation with Seurat OBJ
```{r}
merge_metadata <- function(seurat_obj, external_metadata, cell_id_col) {
  # Extract the metadata from the Seurat object
  seurat_metadata <- seurat_obj@meta.data
  
  # Merge the Seurat metadata with the external metadata
  merged_metadata <- merge(
    seurat_metadata, 
    external_metadata, 
    by = cell_id_col, 
    all.x = TRUE
  )
  
  # Ensure the rownames of the merged metadata match the original Seurat object
  rownames(merged_metadata) <- merged_metadata[[cell_id_col]]
  
  # Replace the Seurat object's metadata with the merged metadata
  seurat_obj@meta.data <- merged_metadata
  
  return(seurat_obj)
}

# Example usage:
MIDGUT_Elife2 <- merge_metadata(MIDGUT_Elife2, Author_metadata,cell_id_col = "cellID")

```

change active ident to assigned_cell_type
```{r}
Idents(MIDGUT_Elife2) <- MIDGUT_Elife2@meta.data$assigned_cell_type
```

#############
#############MARK
##############
##############
#run standard pipeline of seurat
```{r}
# run standard anlaysis workflow
MIDGUT_Elife2 <- NormalizeData(MIDGUT_Elife2)
MIDGUT_Elife2 <- FindVariableFeatures(MIDGUT_Elife2)
MIDGUT_Elife2 <- ScaleData(MIDGUT_Elife2)

min(nrow(MIDGUT_Elife2), ncol(MIDGUT_Elife2))
MIDGUT_Elife2 <- RunPCA(MIDGUT_Elife2,npcs = 50,verbose = T)


MIDGUT_Elife2 <- FindNeighbors(MIDGUT_Elife2, dims = 1:30, reduction = "pca", verbose=TRUE)


MIDGUT_Elife2 <- FindClusters(MIDGUT_Elife2, resolution = 0.6, cluster.name = "MIDGUT_Elife_clusters")

```


#Run UMAP to build the reduciton slot of SOBJ
```{r}

MIDGUT_Elife3 <- RunUMAP(MIDGUT_Elife2, dims = 1:30, reduction = "pca", reduction.name = "UMAP_MIDGUT_Elife",verbose=T)



#change UMAP reduction coordinates to Author's

head(MIDGUT_Elife3@reductions[["UMAP_MIDGUT_Elife"]]@cell.embeddings)

#change reduciton UAMP coordinates to the one in authos's annotation
MIDGUT_Elife3@reductions[["UMAP_MIDGUT_Elife"]]@cell.embeddings[,1] <- MIDGUT_Elife3@meta.data$UMAP_1

MIDGUT_Elife3@reductions[["UMAP_MIDGUT_Elife"]]@cell.embeddings[,2] <- MIDGUT_Elife3@meta.data$UMAP_2

head(MIDGUT_Elife3@reductions[["UMAP_MIDGUT_Elife"]]@cell.embeddings)


Idents(MIDGUT_Elife3) <- MIDGUT_Elife3@meta.data$annotation


```

#DimPlot of UMAP
```{r}

#Now plot the UMAP Dimplot

pdf("./Dimplot/MIDGUT_Elife_UMAP_Dimplot.pdf",width = 9,height = 6)
DimPlot(MIDGUT_Elife3,reduction = "UMAP_MIDGUT_Elife",raster = F,label = T)
dev.off()

```

#convert FBgn to gene symbol in counts slot
```{r}
rownames(MIDGUT_Elife3@assays$originalexp$counts)


dim(MIDGUT_Elife3@assays$originalexp$counts)
#[1] 12872 12149

MIDGUT_Elife3@assays$originalexp$counts



originalexp_counts <- as.data.frame(MIDGUT_Elife3@assays$originalexp$counts)
#########mapping FBGN to gene symbol

annotation_table <- fread("./FBgn2Symbol.csv",header = F)

#map ID
ID_to_symbol <- function(expr_data){
  df=expr_data
  if(sum(colnames(df)=="gene_name", na.rm=TRUE)){
    df$gene_name <- ""
    for (i in 1:nrow(df)){
      if(df$ID[i]%in%annotation_table$V1==TRUE){
        df$gene_name[i] <-
          annotation_table$V2[which(df$ID[i]==annotation_table$V1)]
      }else{
        df$gene_name[i] <- "No_map"
      }
    }
    print(
      paste(sum(df$gene_name=="No_map", na.rm=TRUE)," _unmapped",sum(df$gene_name!="No_map", na.rm=TRUE)," mapped")
    );
  }
  else{
    print("there is no column called 'gene_name', use df$gene_name <- ''");
  }
  return(df)
}

originalexp_counts$ID <- rownames(originalexp_counts)
originalexp_counts$gene_name <- ''

originalexp_counts2 <- ID_to_symbol(originalexp_counts)
#"32  _unmapped 12840  mapped"


which(originalexp_counts2$gene_name=="No_map")

##get the FBGN of these unmapped ID

originalexp_counts2$ID[which(originalexp_counts2$gene_name=="No_map")]
####might need to manually map these with flybase ID validator

write.table(file = "./Unampped_ID.txt",
            originalexp_counts2$ID[which(originalexp_counts2$gene_name=="No_map")],
            sep = ",",
            quote = F,
            col.names = F,
            row.names = F
            )
####
```

#import unmapped2symbol done based on flybase ID validator
```{r}
unmapped2symbol <- fread("./FlyBase_Fields_download_Unmapped2Symbol.txt",header = T)

originalexp_counts2$gene_name[which(originalexp_counts2$gene_name=="No_map")] <- unmapped2symbol$SYMBOL

originalexp_counts2$gene_name[which(originalexp_counts2$gene_name=="No_map")]
#character(0)
#successfully mapped


#convert FBgn in counts slot in midgut seurat obj into gene symbol, so feature plot can be made
MIDGUT_Elife3@assays[["originalexp"]]@counts@Dimnames[[1]] <- originalexp_counts2$gene_name

MIDGUT_Elife3@assays[["originalexp"]]@var.features <- originalexp_counts2$gene_name

MIDGUT_Elife3@assays[["originalexp"]]@data@Dimnames[[1]]<- originalexp_counts2$gene_name

MIDGUT_Elife3@assays[["originalexp"]]@meta.features[["gene_name"]]<- originalexp_counts2$gene_name

#check now
MIDGUT_Elife3@assays[["originalexp"]]@counts@Dimnames[[1]]
MIDGUT_Elife3@assays[["originalexp"]]@var.features
MIDGUT_Elife3@assays[["originalexp"]]@data@Dimnames[[1]]
MIDGUT_Elife3@assays[["originalexp"]]@meta.features[["gene_name"]]
#now FBgn is converted to gene symbol in all slots
```

#generate feature plot of III markers
```{r}
Assays(MIDGUT_Elife3)
DefaultAssay(MIDGUT_Elife3) 

#feature plot based on UMAP reduction
for (i in length(III_Markers)) {
  tmp <- Seurat::FeaturePlot(MIDGUT_Elife3, features = III_Markers[i],  cols = c("grey","darkred"), reduction = "UMAP_MIDGUT_Elife",keep.scale = "feature",slot = "counts");
  ggsave(tmp,device = "pdf",file= paste0("./Featureplot/Featureplot_MIDGUT_UMAP_",III_Markers[i],".pdf"),width = 9,height = 6);
}

#plot hemocyte-specific marker Hml
ggsave(Seurat::FeaturePlot(MIDGUT_Elife3, features = "Hml",  cols = c("grey","darkred"), reduction = "UMAP_MIDGUT_Elife",keep.scale = "feature",slot = "counts",raster = F,pt.size = 0.005),
       device = "pdf",
       file= paste0("./Featureplot/Featureplot_MIDGUT_UMAP_","Hml",".pdf"),width = 9,height = 6)
```

find marker genes in each cluster
```{r}

Idents(MIDGUT_Elife3) <- MIDGUT_Elife3@meta.data$annotation
# 
# MIDGUT_Elife3@assays[["RNA"]] <- MIDGUT_Elife3@assays[["originalexp"]]
# 
# SCTransform(MIDGUT_Elife3)

#JoinLayers(MIDGUT_Elife3)

all.markers <- FindAllMarkers(MIDGUT_Elife3, test.use = 'wilcox', only.pos = F, min.pct = 0, logfc.threshold = 0,group.by="annotation")

```


#save wk image
```{r}
save.image("./MIDGUT_Elife_wkimage.RData")
```

